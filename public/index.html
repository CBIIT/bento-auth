<!-- The top of file index.html -->
<html itemscope itemtype="http://schema.org/Article">
<head>
    <!-- BEGIN Pre-requisites -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
    </script>

    <script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
    </script>
    <!-- END Pre-requisites -->
    <script>
        function start() {
            gapi.load('auth2', function() {
                auth2 = gapi.auth2.init({
                    client_id: '196014713877-0d926jpdd691roubuc0kpu6r6ha9b9t5.apps.googleusercontent.com',
                    // Scopes to request in addition to 'profile' and 'email'
                    //scope: 'additional_scope'
                });
            });
        };
    </script>
</head>
<body>
    <h1>Google Login Test page</h1>
    <!-- Add where you want your sign-in button to render -->
    <!-- Use an image that follows the branding guidelines in a real app -->
    <div style="display: flex;flex-direction: column;align-items: flex-start;">
        <button id="signinButton">Sign in with Google</button>
<!--        <button id="signinLoginGoogle"><a href="/api/auth/login_process">Sign in with Google</a></button>-->
        <button id="signinLoginGovButton"><a href="/gov_external_login">Sign in Login.gov</a></button>
        <button id="signinNihTrustButton"><a href="/nih_external_login">Sign in NIH iTrust</a></button>
        <button id="nihUserVerify">Get NIH User Info</button>
        <button id="govUserVerify">Get Gov Login User Info</button>
    </div>
    <div>
        <button id="logout">Google Sign out</button>
        <button id="gov_logout">Login GOV Sign out</button>
        <button id="nih_logout">NIH Sign out</button>
    </div>
    <div>
        <button id="authenticated">Authenticated?</button>
    </div>
    <div>
        <button id="file_service">Request File</button>
    </div>
    <p id="login_text">Not logged in</p>
    <script>
        $("#nihUserVerify").click(function(){
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const auth_code = urlParams.get('code');
            console.log('auth_code: ' + auth_code);
            fetch(`/nih_user?` + new URLSearchParams({
                code: auth_code
            }), {
                method: 'GET'
            })
            .then(response => response.json())
            .then((responseData) => {
                console.log(JSON.stringify(responseData));
            })
        });

        $("#govUserVerify").click(function(){
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const auth_code = urlParams.get('code');
            console.log('auth_code: ' + auth_code);
            fetch(`/log_gov_user?` + new URLSearchParams({
                code: auth_code
            }), {
                method: 'GET'
            })
                .then(response => response.json())
                .then((responseData) => {
                    console.log(JSON.stringify(responseData));
                })
        });

        $('#signinButton').click(function() {
            // signInCallback defined in step 6.
            auth2.grantOfflineAccess().then(signInCallback);
        });

        $('#gov_logout').click(function() {
            govSignOut();
        });

        $('#nih_logout').click(function() {
            nihSignOut();
        });

        $('#logout').click(function() {
            // signInCallback defined in step 6.
            signOut();
        });

        $('#authenticated').click(function() {
            // signInCallback defined in step 6.
            authenticated();
        });
        $('#file_service').click(function() {
            // signInCallback defined in step 6.
            requestFile();
        });
    </script>

    <!-- Last part of BODY element in file index.html -->
    <script>
        // google popup login
        function loginGovsignInCallback(authResult) {
            console.log('loginGovsignInCallback' + authResult);
            if (authResult['code']) {
                // $('#signinButton').css('display', 'none');
                (async () => {
                    const rawResponse = await fetch('/api/auth/login/', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code: authResult['code'] })
                    });
                    const content = await rawResponse.json();
                    if (content.name) {
                        $('#login_text').text("Logged in");
                    } else {
                        $('#login_text').text("Not logged in");
                    }
                })();
            }
        }
        // google popup login
        function signInCallback(authResult) {
            if (authResult['code']) {
                // Hide the sign-in button now that the user is authorized, for example:
                $('#signinButton').attr('style', 'display: none');
                // Send the code to the server
                (async () => {
                    const rawResponse = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({code: authResult['code']})
                    });
                    const content = await rawResponse.json();
                    console.log(content);
                })();
            } else {
                // There was an error.
            }
        }

        async function nihSignOut() {
            const rawResponse = await fetch('/nih_logout', {
                method: 'GET'
            });
            const content = await rawResponse.json();

            if (content.status) {
                $('#login_text').text("Not logged in");
                $('#signinButton').css('display', 'block');
            }
            console.log(content);
        }

        async function govSignOut() {
            const rawResponse = await fetch('/gov_logout', {
                method: 'GET'
            });
            const content = await rawResponse.json();

            if (content.status) {
                $('#login_text').text("Not logged in");
                $('#signinButton').css('display', 'block');
            }
            console.log(content);
        }

        async function signOut() {
            const rawResponse = await fetch('/api/auth/logout/', {
                method: 'GET'
            });
            const content = await rawResponse.json();

            if (content.status) {
                $('#login_text').text("Not logged in");
                $('#signinButton').css('display', 'block');
            }
            console.log(content);
        }
        async function authenticated() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            if (!urlParams.get('code') && !urlParams.get('type')) return;
            const auth_type = urlParams.get('type');
            const auth_code = urlParams.get('code');
            if (auth_type === 'nih') {

                console.log('auth_code: ' + auth_code);
                fetch(`/nih_user?` + new URLSearchParams({
                    code: auth_code
                }), {
                    method: 'GET'
                })
                    .then(response => response.json())
                    .then((responseData) => {
                        console.log(JSON.stringify(responseData));
                        $('#login_text').text('NIH ' + responseData.user.name + ' Logged in');
                    })

            } else if (auth_type === 'gov') {
                console.log('auth_code: ' + auth_code);
                fetch(`/log_gov_user?` + new URLSearchParams({
                    code: auth_code
                }), {
                    method: 'GET'
                })
                    .then(response => response.json())
                    .then((responseData) => {
                        console.log(JSON.stringify(responseData));
                        $('#login_text').text('Login.GOV ' + responseData.user.email + ' Logged in');
                    })

            } else {
                const rawResponse = await fetch('/api/auth/authenticated/', {
                    method: 'GET'
                });
                const content = await rawResponse.json();
                if (content.status) {
                    $('#login_text').text("Logged in");
                } else {
                    $('#login_text').text("Not logged in");
                }

                console.log(content);
            }
        }
        async function requestFile() {
            const rawResponse = await fetch('/api/auth/files/BENTO-FILE-217910', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            const content = await rawResponse.json();
            console.log(content);
        }
    </script>
    <script type="text/javascript">
        window.onload = authenticated;
    </script>
</body>
</html>