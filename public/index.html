<!-- The top of file index.html -->
<html itemscope itemtype="http://schema.org/Article">
<head>
    <!-- BEGIN Pre-requisites -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
    </script>

    <script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
    </script>
    <!-- END Pre-requisites -->
    <script>
        function start() {
            gapi.load('auth2', function() {
                auth2 = gapi.auth2.init({
                    client_id: '196014713877-0d926jpdd691roubuc0kpu6r6ha9b9t5.apps.googleusercontent.com',
                    // Scopes to request in addition to 'profile' and 'email'
                    //scope: 'additional_scope'
                });
            });
        };
    </script>
</head>
<body>
    <h1>Google Login Test page</h1>
    <!-- Add where you want your sign-in button to render -->
    <!-- Use an image that follows the branding guidelines in a real app -->
    <div style="display: flex;flex-direction: column;align-items: flex-start;">
<!--        <button id="signinButton">Sign in with Google</button>-->
        <button id="signinLoginGoogle"><a href="/api/auth/login_process">Sign in with Google</a></button>
        <button id="signinLoginGovButton"><a href="/api/auth/login_process">Sign in Login.gov</a></button>
        <button id="signinNihTrustButton">Sign in NIH iTrust</button>
    </div>
    <div>
        <button id="logout">Sign out</button>
    </div>
    <div>
        <button id="authenticated">Authenticated?</button>
    </div>
    <div>
        <button id="file_service">Request File</button>
    </div>
    <p id="login_text">Not logged in</p>
    <script>
        $('#signinButton').click(function() {
            // signInCallback defined in step 6.
            auth2.grantOfflineAccess().then(signInCallback);
        });
        $('#logout').click(function() {
            // signInCallback defined in step 6.
            signOut();
        });
        $('#authenticated').click(function() {
            // signInCallback defined in step 6.
            authenticated();
        });
        $('#file_service').click(function() {
            // signInCallback defined in step 6.
            requestFile();
        });
    </script>

    <!-- Last part of BODY element in file index.html -->
    <script>
        // google popup login
        function signInCallback(authResult) {
            if (authResult['code']) {
                $('#signinButton').css('display', 'none');


                (async () => {
                    const rawResponse = await fetch('/api/auth/login/', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code: authResult['code'] })
                    });
                    const content = await rawResponse.json();
                    if (content.name) {
                        $('#login_text').text("Logged in");
                    } else {
                        $('#login_text').text("Not logged in");
                    }
                })();

            }
        }
        async function signOut() {
            const rawResponse = await fetch('/auth/logout/', {
                method: 'GET'
            });
            const content = await rawResponse.json();

            if (content.status) {
                $('#login_text').text("Not logged in");
                $('#signinButton').css('display', 'block');
            }
            console.log(content);
        }
        async function authenticated() {
            const rawResponse = await fetch('/auth/authenticated/', {
                method: 'GET'
            });
            const content = await rawResponse.json();
            if (content.status) {
                $('#login_text').text("Logged in");
            } else {
                $('#login_text').text("Not logged in");
            }


            console.log(content);
        }
        async function requestFile() {
            const rawResponse = await fetch('/api/auth/files/BENTO-FILE-217910', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            const content = await rawResponse.json();
            console.log(content);
        }
    </script>
    <script type="text/javascript">
        window.onload = authenticated;
    </script>
</body>
</html>